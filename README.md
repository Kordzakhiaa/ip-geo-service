# IP Geolocation Service

**FastAPI microservice** to provide geolocation information for IPv4 addresses.
Designed as part of LivaNova Backend Engineering take-home assignment.

---

## Table of Contents

- [Overview](#overview)
- [Features](#features)
- [Tech Stack](#tech-stack)
- [Setup & Installation](#setup--installation)
- [Running the Service](#running-the-service)
- [Testing](#testing)
- [API Documentation](#api-documentation)
- [API Endpoints](#api-endpoints)
- [API Design Decisions](#api-design-decisions)
- [Production Considerations](#production-considerations)

---

## Overview

This microservice provides geolocation information for any valid IPv4 address using a **third-party IP geolocation API
** (`ip-api.com`). It supports:

- Lookup by client IP (automatic detection)
- Lookup by explicit IP
- Returns: country, region, city, coordinates, timezone, ISP
- Handles invalid IPs, private IPs, and provider/network failures gracefully

---

## Features

- `/api/v1/geo` — Returns geolocation for the client IP
- `/api/v1/geo/{ip}` — Returns geolocation for a given IP
- `/health` — Simple liveness endpoint
- Async HTTP requests using `httpx`
- Pydantic models for validation (`GeoResponse` and `ErrorResponse`)
- Configurable via environment variables (`IP_API_URL`, `IP_API_TIMEOUT`)
- Full OpenAPI documentation
- Robust error handling (400, 404, 502, 500)
- Unit & integration tests with `pytest` and `monkeypatch`

---

## Tech Stack

- Python 3.11+
- FastAPI
- Pydantic
- httpx (async HTTP client)
- pytest (testing)
- ruff (linting)
- mypy (static typing)
- Docker & docker-compose (optional for local dev)

---

## Setup & Installation

Clone the repository:

```bash
git clone <REPO_URL>
cd ip-geolocation-service
```

## Create virtual environment:

```bash
python -m venv .venv
source .venv/bin/activate  # Linux/macOS
# or .venv\Scripts\activate  # Windows
```

## Install dependencies:

```bash
pip install -r requirements.txt
```

## Configure environment variables (optional, defaults are set in app/core/settings.py):

```bash
export IP_API_URL="http://ip-api.com/json/{ip}"
export IP_API_TIMEOUT=5

```

## Running the Service

### Using Python directly

```bash
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

#### Visit:

- API root: http://localhost:8000
- Swagger UI: http://localhost:8000/docs
- ReDoc UI: http://localhost:8000/redoc

## Using Docker

```bash
docker-compose up --build
```

## Testing

### Run all tests with:

```bash
pytest
```

- Async endpoints are fully tested using pytest.mark.asyncio
- External API calls are mocked using monkeypatch to ensure reliable tests
- Parametrized tests cover edge cases: invalid IP, private IP, request errors, timeouts

## API Documentation

The project includes full OpenAPI/Swagger documentation automatically generated by FastAPI:

- Swagger UI: /docs — interactive API testing
- ReDoc: /redoc — clean, detailed API reference

All endpoints include:

- response_model with examples
- responses mapping for error handling (400, 404, 502)
- Descriptive docstrings visible in the generated docs

## API Endpoints

1. **GET** /api/v1/geo

- **Description**: Returns geolocation information for the client IP
- **Response**: GeoResponse
- **Errors**: 400 (invalid IP), 404 (private range/not found), 502 (provider/network error)

### Example Success Response:

```json
{
  "ip": "8.8.8.8",
  "country": "United States",
  "region": "California",
  "city": "Mountain View",
  "latitude": 37.386,
  "longitude": -122.0838,
  "timezone": "America/Los_Angeles",
  "isp": "Google LLC"
}
```

## 2. GET /api/v1/geo/{ip}

- **Description**: Returns geolocation information for a specific IP
- **Parameters**: ip (path parameter)
- **Response**: GeoResponse
- **Errors**: 400 (invalid IP), 404 (private range/not found), 502 (provider/network error)

## API Design Decisions

- Separate endpoints for client IP and explicit IP for clarity and UX
- response_model used only for success responses; errors handled via HTTPException
- Versioned API path (/api/v1) to allow future breaking changes
- Async HTTP requests to external API for better concurrency
- Logging: f-strings with context to trace issues and simplify debugging
- Input validation using ipaddress module for reliability

## Production Considerations

Next steps for production readiness:

1. Integrate local GeoIP database (MaxMind GeoLite2) with optional fallback to third-party API
2. Implement caching layer (Redis/memory) for frequent lookups
3. Apply rate-limiting and retry/backoff
4. Centralized logging & metrics (Prometheus, Grafana)
5. Distributed tracing (OpenTelemetry)
6. CI/CD pipeline (GitHub Actions)
7. Secrets/config management (API keys)
8. Integration tests & contract tests for external APIs
9. Security: sanitize headers, handle X-Forwarded-For correctly
10. Enhanced OpenAPI docs with examples for all error responses

## Notes

- All IP lookups are currently IPv4-only
- Private or reserved IPs return a 404 with provider message
- This microservice is designed for educational/demo purposes; production deployments require security and observability
  enhancements
